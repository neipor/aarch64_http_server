# ANX Server Configuration

http {
    # This is a comment
    workers 4;
    
    # 日志配置 - Logging Configuration
    error_log ./logs/error.log;
    access_log ./logs/access.log;
    log_level info;
    log_format combined;
    log_rotation_size 100;
    log_rotation_days 7;
    performance_logging on;

    # 压缩配置 - Compression Configuration
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/javascript application/javascript 
              application/json application/xml text/xml application/x-javascript
              text/html;
    gzip_vary on;
    gzip_buffers 32 4k;

    # 静态文件服务器
    server {
        listen 8080;
        server_name localhost;
        
        # 添加全局头部操作
        add_header X-Server-Name ANX-HTTP-Server;
        add_header X-Version 0.5.0;
        
        # 静态文件根目录
        location / {
            root ./www;
            # 为静态文件添加缓存控制头部
            add_header Cache-Control public-max-age-3600;
        }
        
        # API代理到后端服务器
        location /api {
            proxy_pass http://127.0.0.1:3000;
            # 为API路由添加CORS头部
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET-POST-PUT-DELETE-OPTIONS;
            add_header Access-Control-Allow-Headers Content-Type-Authorization;
        }
        
        # 管理接口代理
        location /admin {
            proxy_pass http://127.0.0.1:3001;
            # 为管理界面添加安全头部
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection 1-mode-block;
        }
    }

    # HTTPS服务器
    server {
        listen 8443 ssl;
        server_name localhost;
        ssl_certificate ./certs/server.crt;
        ssl_certificate_key ./certs/server.key;
        
        # 添加HTTPS安全头部
        add_header Strict-Transport-Security max-age-31536000-includeSubDomains;
        add_header X-Forwarded-Proto https;
        
        # 静态文件根目录
        location / {
            root ./www;
            # 为静态文件添加缓存控制头部
            add_header Cache-Control public-max-age-7200;
        }
        
        # API代理到后端服务器
        location /api {
            proxy_pass http://127.0.0.1:3000;
            # 为API路由添加CORS和安全头部
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET-POST-PUT-DELETE-OPTIONS;
            add_header Access-Control-Allow-Headers Content-Type-Authorization;
        }
        
        # 微服务代理
        location /service {
            proxy_pass http://127.0.0.1:3002;
            # 为微服务添加安全头部
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
            add_header Referrer-Policy strict-origin-when-cross-origin;
        }
    }
} 